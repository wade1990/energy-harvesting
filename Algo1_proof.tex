%!TEX root = OptimalOffline.tex
%input{Siddhartha}
\begin{theorem}
Let a transmission policy to solve Problem 1 is given by power vector $\textbf{p}=[p_1,p_2,..,p_N]$ and the start time of transmission for the corresponding power be given by vector $\textbf{s}=[s_1,s_2,..,s_N]$, for some $N\in \mathbb{N}$. The transmission ends at time $s_{N+1}$. Now such a policy is optimal if and only if it satisfies the following structure.
\label{th_algo1_1}
\begin{align}
&\sum_{i=1}^{i=N}g(p_i)(s_{i+1}-s_i)=B_0\label{claim1}
\\
&\nonumber s_{N+1}-s_1=T^R_0 				&&\text{ , if } s_1>0
\\
& \text{ or } s_{N+1}\le T^R_0 				&&\text{ , if } s_1=0\label{claim2}
\\
&\nonumber s_{n+1}=\argmin_{t_i: s_n < t_i \le s_{N+1}} CP(t_i,s_n)
\\
&\text{ and } p_n=CP(s_{n+1},s_n)\label{claim3}
\\
&\exists s_j:s_j\in \textbf{s} \text{ and } s_j=Q\label{claim4}
\end{align}
for $n=\{ 1,2,..,N-1\}$.
\end{theorem}
\begin{proof}
First we show that the optimal policy should have the given structure. The proof follows the method of  contradiction. We establish structure (\ref{claim3}) at first. Assume an optimal policy that satisfies Lemmas 1 to 6 and does not satisfy the given structure (\ref{claim3}). Specifically, say the policy be same as structure (\ref{claim3}) from time $s_{1}$ to $s_n$, for some $n\in \{1,2,..,N\}$ but transmission power right after $s_n$ is not the minimum feasible constant power, i.e.
\begin{align}
p_n>CP(s',s_n)\text{ where } s'=\argmin_{t_i: s_n < t_i \le s_{N+1}} CP(t_i,s_n)\label{claim3_1}
\end{align}

\textit{Case1: }if $s'>s_{n+1}$ for some $n\in \{1,2,..,N-1\}$, then the energy that is used for transmission from time $s'$ to $s_{n+1}$ is given by $\ETx(s'-)-\ETx(s_{n+1}^-)$ in terms of Lemma 3. We claim that that there must be a time duration from $s'$ to $s_{n+1}$ for which the transmission power is less than $p_n$. If this claim is true then we violate lemma \ref{increasing_power} and hence contradict the assumption. Coming to the claim, if it does not hold i.e. transmission power at all points of time between $s_{n+1}$ to $s'$ is more than $p_n$, then the total energy used during this period can be lower bounded by $p_n(s'-s_{n+1})$. Next, we show that this energy is more that what is harvested during $s_{n+1}$ to $s'$ making it infeasible. As transmitting with $CP(s',s_n)$ power is a feasible between time $s'$ and $s_n$, $CP(s',s_n)(s_{n+1}-s_n)\le \ETx(s_{n+1}^-)-\ETx(s_{n}^-)$. So, 
\begin{align}
&\ETx(s'-)-\ETx(s_{n+1}^-) \le \ETx(s'-)-\ETx(s_{n+1}^-)
\\
&+(\ETx(s_{n+1}^-)-\ETx(s_{n}^-)-CP(s',s_n)(s_{n+1}-s_n))
\\
&=CP(s',s_n)(s'-s_{n+1})\stackrel{(\ref{claim3_1})}{<}p_n (s'-s_{n+1}).
\end{align}

\textit{Case2: }if $s'<s_{n+1}$, the transmission policy uses $p_n(s'-s_{n})$ energy from time $s_n$ to $s'$. But $\ETx(s'-)-\ETx(s_{n}^-)=CP(s',s_n)(s'-s_{n})\stackrel{\ref{claim3_1}}{<}p_n(s'-s_{n})$. So, energy used $p_n(s'-s_{n})$ is more than what is harvested making this case infeasible.

%Note that equation (\ref{claim1}) must be followed by the optimal policy as it is a constraint to the optimization problem 1. We move on to prove structure (\ref{claim2}). If $s_1=0$ then $s_{N+1}$ has to be less than or equal to $T^R_0$ due to constraint 1. When $s_1>0$, assume that $s_{N+1}-s_1<T^R_0$. Let $A$ be the first energy arrival such that $E(A)=\ETx(A^-)$. Similarly, let $B$ be the last energy arrival at which $E(B)=\ETx(B^-)$. Now consider the policy where power vector is given by $\{p_1-\alpha,p_1,p_2,..,p_{N-1},p_N,p_N+\epsilon \}$ and the corresponding time vector be given by $\{s_1-\beta,A,s_2,..,s_{N},B\}$ with the transmission ending at time $s_{N+1}-\gamma$, where $\epsilon$ is a small positive constant, $\beta=\frac{\alpha}{p_1-\alpha}(A-s_1) $, $\gamma= \frac{\epsilon}{p_N+\epsilon}(s_{N+1}-B)$. This policy finishes before the previous policy and hence contradicts its optimality only if we are able to show that it is feasible. Such a policy would be feasible with respect to the energy constraint keeping in mind that transmission with power $p_N+\epsilon $ from time $A$ to $s_{N+1}-\gamma$ was previously never on the boundary of feasibility constraint 1 and similarly for power $p_1-\alpha $. Now we see its feasibility with constraint 2. For every $\epsilon \rightarrow 0^{+}$ we can find a value of $\alpha$ such that the number of bits transmitted in this new policy remains the same as the previous one i.e. $B_0$. So, excluding the common terms from equating the number of bits boils to
%\begin{align}
%&\nonumber g(p_N)(s_{N+1}-B)+g(p_1)(A-s_1)
%\\
%&\nonumber =g(p_1-\alpha)(A-s_1+\beta)+g(p_N+\epsilon)(s_{N+1}-B-\gamma)
%\\
%&\nonumber\implies (s_{N+1}-B)(g(p_N)-g(p_N+\epsilon)\frac{p_N}{p_N+\epsilon})
%\\
%&=(A-s_1)(g(p_1-\alpha)\frac{p_1}{p_1-\alpha}-g(p_1))\label{bits}
%\end{align} 
%Now the total time for which the transmission is \textit{on} is $s_{N+1}-s_1+\beta-\gamma$.


Note that equation (\ref{claim1}) must be followed by the optimal policy as it is a constraint to the optimization problem 1. We move on to prove structure (\ref{claim2}). If $s_1=0$ then $s_{N+1}$ has to be less than or equal to $T^R_0$ due to constraint 1. When $s_1>0$, assume that $s_{N+1}-s_1<T^R_0$. Let $A$ be the first energy arrival such that $E(A)=\ETx(A^-)$. Similarly, let $B$ be the last energy arrival at which $E(B)=\ETx(B^-)$. Now consider the policy where power vector is given by $\{p_1+dp_1,p_1,p_2,..,p_{N-1},p_N,p_N+dp_N \}$ and the corresponding time vector be given by $\{s_1+ds_1,A,s_2,..,s_{N},B\}$ with the transmission ending at time $s_{N+1}+ds_{N+1}$, where $dp_N>0$ and  $dp_1,ds_1, ds_{N+1}<0$ . This policy finishes before the previous policy and hence contradicts its optimality only if we are able to show that it is feasible. Such a policy would be feasible with respect to the energy constraint keeping in mind that transmission with power $p_N$ from time $A$ to $s_{N+1}$ was previously never on the boundary of feasibility constraint 1 and similarly for power $p_1$. Now we see its feasibility with respect to constraint 2. It can be seen that
\begin{align}
&p_1ds_1=(A-s_1)dp_1\text{ , }p_Nds_{N+1}=-(s_{N+1}-B)dp_N
\end{align}
The number of bits transmitted from time $s_1$ to $A$ is given by $B_1=g(p_1)(A-s_1)$ and similarly, from $B$ to $s_{N+1}$ be given by $B_N=g(p_N)(s_{N+1}-B)$ under the previous policy. Noting that the number of bits sent in the two policies remains same we get,
\begin{align}
&\nonumber dB_1+dB_2=0
\\
&\nonumber\implies g'(p_1)(A-s_1)dp_1-g(p_1)ds_1
\\
&\nonumber +g'(p_N)(s_{N+1}-B)dp_N+g(p_N)ds_{N+1}=0
\\
&\nonumber\implies \frac{-ds_1}{-ds_{N+1}}=\frac{(g'(p_N)p_N-g(p_N))}{(g'(p_1)p_1-g(p_1)}
\end{align}
We can verify that $g'(p)p-g(p)$ is an increasing function of $p$ for $p>0$ due to concavity of $g(p)$. Hence $(-ds_1)\ge (-ds_{N+1})$. The time for which transmission is on in this policy is $s_{N+1}-s_1+ds_{N+1}-ds_1\ge s_{N+1}-s_1$. As $s_{N+1}-s_1<T^R_0$, we can choose arbitrarily small negative value of $ds_{N+1}$ so that $s_{N+1}-s_1\le s_{N+1}-s_1+ds_{N+1}-ds_1<T^R_0$ holds. So the new policy finishes earlier than the previous policy contradicting the optimality. This concludes that $s_{N+1}-s_1=T^R_0$ (if $s_1\neq 0$) in optimal policy.

Next, we prove the sufficiency of the structure. Let the power vector $\textbf{p}$ and time vector $\textbf{s}$ follow the structure. We need to show that this policy is optimal. Assume that there exists another policy given by $\{\textbf{p'},\textbf{s'}\}$ which abides by the Lemma 1-5 and is optimal, but does not follow the structure. We argue next that such a policy is not feasible and hence contradict its optimality. 

\textit{Case1}: If $s_1'>s_1\ge 0$ then by Lemmma  $s_{N'+1}'>s_{N+1}$. So policy $\{\textbf{p'},\textbf{s'}\}$ cannot be optimal. 

\textit{Case2}: Suppose $s_1'=s_1$. Let $s_i'$ be the first epoch for which $p_i'\ne p_i$ for some $i \in \{1,2,..,N\}$. By (\ref{claim3}), $p_i'>p_i$. If $s_{N'+1}'>s_{i+1}$, then the amount of energy used by policy $\{ \textbf{p'},\textbf{s'}\}$ in interval $[s_{i},s_{i+1}]$ is more than policy $\{\textbf{p},\textbf{s}\}$. But by Lemma, $\{\textbf{p},\textbf{s}\}$ uses all energy available by $s_{i+1}$. So policy $\{\textbf{p'},\textbf{s'}\}$ is not feasible with respect to the energy constraint. If $s_{N'+1}'\le s_{i+1}$, then it can be easily verified by property P4 that policy $\{\textbf{p'},\textbf{s'}\}$ transmits strictly less number of bits in interval $[s_i,s_{N'+1}]$ than the other policy in interval $[s_{i},s_{i+1}]$. Both policies being same till $s_i$, we conclude that policy $\{\textbf{p'},\textbf{s'}\}$ transmits less than $B_0$  bits and therefore it is not optimal.

\textit{Case3}: This case argues the infeasibility when $s_1'<s_1$. Unlike other cases this case is more rigorous. The idea of the proof is to show that if we start our transmission early and finish earlier than policy $\{\textbf{p},\textbf{s}\}$, we always take more transmission time which is going to violate the time constraint. First, we establish that the policy $\{\textbf{p'},\textbf{s'}\}$ must be same as policy $\{\textbf{p},\textbf{s}\}$ from epoch $s_2$ to an epoch $s_j$ such that $s_j=\max_{s_i<s_{N'+1}'} s_i$. Let $s_k'=max_{s_i'<s_2}s_i'$ and transmission continues with constant power $p_k'$ till $s_l'$. If $s_l'>s_2$, then transmission with a constant power $\dfrac{\ETx(s_l^{,-})}{(s_l'-s_1)} $ from $s_1$ to $s_l'$ is feasible and $\dfrac{\ETx(s_l^{,-})}{(s_l'-s_1)}<\dfrac{\ETx(s_2^-)}{(s_2-s_1)}=p_1$. This contradicts $\ref{claim3}$. So, $s_l'=s_2$. Now, if $p_l'>p_2$ and $s_j>s_3$, then the amount of energy used by policy $\{\textbf{p'},\textbf{s'}\}$ between $s_2$ and $s_3$ is more than what is harvested. So $p_l'=p_2$ ($s_{l+1}=s_3$) and similarly we can show that $p_{l+1}=p_3$.. ($ s_{l+2}=s_4$..) till epoch $s_j$. By Lemma and (\ref{claim4}) we can be sure that there exists atleast one epoch $s_i$ which belongs to $\textbf{s}$ as well as $\textbf{s'}$ i.e. $j\ge 2$.

Now, consider the following process which creates child feasible policies from policy $\{\textbf{p'},\textbf{s'}\}$. We define two pivots $pv_1$ and $pv_2$. Initially we set $pv_1=s_2'$ and $pv_2=s_{N'}'$. The transmission power right before $pv_1$ is $u$ ($u=p_1'$ initially) and right after $pv_2$ is $v$ ($v=p_{N'}'$ initially). Keeping the policy same from $pv_1$ to $pv_2$ we increase $u$ by a small amount to $u+du$ and decrease $v$ by a small amount to $v-dv$ so that the number of bits transmitted( i.e. $B_0$) remains same under this transformation. Let $s_1'$ change to $s_1'+x$ and $s_{N'+1}'$ change to $s_{N'+1}'+y$ for some $x,y>0$. Following the argument provided while proving the necessary statement of this Theorem, we can conclude that $x>y$ and hence. We denote such a policy by vectors $\{\textbf{p'(x)},\textbf{s'(x)}\}$. Note that $(s_{N'(x)+1}'(x)-s_1'(x))<(s_{N'+1}'-s_1')$. We continue increasing $x$ till either $u=p_2$ (in which case we change $pv_1=s_2$) or $v=p_{N'-1}'$ (where we change $pv_2=s_{N'-1}'$) or $s_{N'(x)+1}'(x)$ hits a epoch, say $t_j$ ($pv_2=t_j$, $v\rightarrow\infty$ in this case). After this, we again start increasing $x$ with changed definitions. We continue this process till $x=s_1-s_1'$  or $u$ becomes equal to $v$. Note that the former stopping criteria will be met at a smaller $x$ than the later one since policy $\{\textbf{p'(x)},\textbf{s'(x)}\}$ shares at least one epoch with policy $\{\textbf{p'},\textbf{s'}\}$ by arguments of previous paragraph. By maintaining these rules we ensure that policy $\{\textbf{p'(x)},\textbf{s'(x)}\}$ abides by Lemma 1-6 and is feasible with energy constraint. Since $s_{N'(x)+1}'(x)-s_1'(x)$ is decreasing with $x$, the policy is also feasible with time constraint. As this is a continuous function on $x$, at $x=s_1-s_1'$ we reach a policy such that $s_1'(x)=s_1$. At $x=s_1-s_1'$, if $s_{N'(x)+1}'(x)\ge s_{N+1}$ then $s_{N'+1}'-s_1'>s_{N'(x)+1}'(x)-s_1'(x)\ge T^R_0$ and policy $\{\textbf{p'},\textbf{s'}\}$ is infeasible with time constraint. If $s_{N'(x)+1}'(x)< s_{N+1}$ then we can follow the arguments in \textit{Case2} to show that policy $\{\textbf{p'(x)},\textbf{s'(x)}\}$ is infeasible, which in turn accounts for the infeasibility of policy $\{\textbf{p'},\textbf{s'}\}$.
\end{proof}

























%input{Rushil}
\begin{theorem}
The policy described by the above algorithm is optimal.
\end{theorem}
\begin{proof}
To prove that our policy is optimal, we have to show that it is of the structure described in the previous theorem. \\
That is, $s_{stop} - s_0 \leq T$ and \\
\textbf{Things to write}\\
First we prove that the power allocations in this algorithm are in accordance with \textbf{insert}\\
In the first part of the algorithm, we select the maximum slope at a corner point before $s_{left}$ and after $s'_{start}$ and ending at $s_{left}$. \\
First we try to show that this is also the maximum such slope between any corner point before $s_{left}$ and after $s_{start}$ where $s_{start}$ is the final start point. \\
Suppose it is not. Then we have a corner point between $s_{start}$ and $s'_{start}$ such that we can transmit with a power higher than our maximum between these two points. But, if this were possible, then 
$p_{left}$ itself would have been feasible, which is not the case. (See figure).\\
Now we seek to show that this procedure of selecting maximum slopes going 'backwards' also gives us the minimum slopes going 'forwards', as described in \textbf{insert}.\\
We shall show this by contradiction. Let $s_i$, $s_j$ and $s_k$ be three consecutive corner points where the power of transmission increases, as per our allocation. Now suppose, it is possible to transmit with a lowe power between $s_i$ and some $s'_j$. 
Then the power of transmission between $s_j$ and $s_k$ is not the maximum power since we could transmit at a higher power from $s'_j$ and $s_k$. Which is a contradiction as this is not consistent with out allocation algorithm.\\
Therefore, the allocation policy before point $Q$ is consistent with \textbf{insert}. (See figure)
We can prove similarly for the powers after point $Q$.
\end{proof}




