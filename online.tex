% !TEX root = main.tex
\textit{Notation:} The starting time of the transmission is denoted by $T_{start}$ and the present time is denoted by $t$. The number of bits and energy remaining to transmit at any Transmitter energy epoch is represented by $B_{rem}$ and $E_{rem}$ receptively.

The on-line algorithm that we propose is presented in Algorithm \ref{algo_online}. The Algorithm waits till time $T_{start}$ which marks the first energy arrival at transmitter or 'time' addition at receiver such that using the energy $\ETx(T_{start})$ and time $\TRx(T_{start})$, $B_0$ or more bits can be transmitted.
\begin{equation}
T_{start}=\min\ t \ s.t.\  \TRx(t)g\Bigg{(} \dfrac{\ETx(t)}{\TRx(t)}\Bigg{)}\ge B_0.\label{online_T_start}
\end{equation}

To begin with, transmitter equally divides $\ETx(T_{start})$ energy among all $B_0$ bits and we know that this transmission is going to finish in less than $\TRx(T_{start})$ time. If and when new energy arrives at transmitter, the energy left at that instant, $E_{rem}$, is equally divided among the bits left to transmit i.e. $B_{rem}$.

\begin{algorithm}
\caption {On-line Algorithm for energy harvesting transmitter and receiver.}
\footnotesize
\label{algo_online}
\begin{algorithmic}[1]
\State \textbf{Input}: Bits to transmit $B_0$; $\ETx_i$, $\TRx_i$ for $t_i,r_i<t$ where $t$ is the present time instant which increments parallely with this algorithm. 

\State $T_{start}=\min\ t$ s.t. $\TRx(t)g\Bigg{(} \dfrac{\ETx(t)}{\TRx(t)}\Bigg{)}\ge B_0$
\State $B_{rem}=B_0$, $E_{rem}=\ETx(T_{start})$, $m=T_{start}$

\Do
	\State Transmit at power $p$ such that $\dfrac{E_{rem}}{p} g(p)= B_{rem}$
	\If {$t=t_i$ for some $i$} 
		\State $B_{rem}=B_{rem}-(t-m)g(p)$
		\State $E_{rem}=E_{rem}+\ETx_i-(t-m)p$
		\State $m=t_i$
	\EndIf
\DoWhile {$t\le \left( m+\dfrac{E_{rem}}{p}\right)$}
\end{algorithmic}
\end{algorithm}

\begin{lemma}
The transmit power in the on-line algorithm is non-decreasing with time after $T_{start}$.
\label{online_power}
\end{lemma}
\begin{proof}
From the definition of the algorithm the transmit power only changes when there is a new energy arrival after $T_{start}$. So, if there is no energy arrival, the transmit power is same i.e. non decreasing. Suppose there are energy arrivals after $T_{start}$ and for any energy arrival(say $E_{new}$) the power changes from $p_i$ to $p_{i+1}$. Let the energy remaining at start of transmission with power $p_i$ be $E_{rem}$ and bits remaining be $B_{rem}$. The transmission continues for time $l_i$ with power $p_i$. Now, we need to show that $p_i<p_{i+1}$. Form the algorithm we get the following equations. 
\begin{align}
&\frac{g(p_i)}{p_i}=\frac{B_{rem}}{E_{rem}} \label{power_increasing_eq1}
\\
&\frac{g(p_{i+1})}{p_{i+1}}=\frac{B_{rem}-g(p_i) l_i}{E_{rem}+E_{new}-p_i l_i}\label{power_increasing_eq2}
\end{align}
Substituting $g(p_i)$ from (\ref{power_increasing_eq1}) into RHS of (\ref{power_increasing_eq2}) we can see that $\frac{g(p_i)}{p_i}>\frac{g(p_{i+1})}{p_{i+1}}$. Hence by property $P4$ we know that $p_i<p_{i+1}$.
\end{proof}
\begin{theorem}
The competitive ratio of the on-line algorithm presented in Algorithm \ref{algo_online} is less than 2.
\end{theorem}
\begin{proof}
This is equivalent to saying that the time taken by the on-line algorithm can at max be twice the time taken by optimal off-line algorithm. Let the time taken by the off-line version be $T_{off}$ and the on-line version be $T_{online}$. 

We now show that 
\begin{align}
T_{off} > T_{start}
\label{online_time}
\end{align}
This proof follows from contradiction. Let $T_{off}\le T_{start}$. From \eqref{online_T_start}, either $T_{start}=t_i$ for some $i$ and/or $T_{start}=r_j$ for some $j$. Let $\{\textbf{p},\textbf{s},N\}$ ($T_{off}=s_{N+1}$) be the off-line policy.

If $T_{start}=t_i$, then as $T_{off}\le T_{start}$, the maximum energy that can be utilized by the off-line algorithm is $\ETx(T_{start}^-)=\ETx(T_{start})-\ETx_i$. Note that the off-line algorithm cannot use energy arrival $\ETx_i$, as using any finite amount of energy for 0 time cannot deliver any bits. If $T_{start}=r_j$, then then the maximum time for which the receiver can be \textit{on} is $(s_{N+1}-s_1) \le\TRx(T_{start}^-)=\TRx(T_{start})-\TRx_j$, as the off-line policy has to finish at or before $T_{start}$. 
%If $T_{start}\neq t_i$ or $T_{start}\neq r_j$ then, $\ETx(T_{start}^-)=\ETx(T_{start})$ or $\TRx(T_{start}^-)=\TRx(T_{start})$.
So the number of bits transmitted by the off-line policy $\{\textbf{p},\textbf{s},N\}$ is given by,
\begin{align}
&\sum_{i=1}^{i=N} g(p_i)(s_{i+1}-s_{i}),
\\
&\le g\left(\sum_{i=1}^{i=N}p_i\left(\frac{(s_{i+1}-s_{i})}{\sum_{j=1}^{j=N}(s_{i+1}-s_{i})}\right)\right) \sum_{j=1}^{j=N} (s_{i+1}-s_{i}),\label{online_eq_3}
\\
&=g\left(\frac{\displaystyle\sum_{i=1}^{i=N}p_i(s_{i+1}-s_{i})}{(s_{N+1}-s_{1})}\right)(s_{N+1}-s_{1}),\label{online_eq_4} 
\\
&\le g\left(\frac{\displaystyle\sum_{i=1}^{i=N}p_i(s_{i+1}-s_{i})}{\TRx(T_{start}^-)}\right)\TRx(T_{start}^-), \label{online_eq_1}
\\
&\le g\left(\frac{\ETx(T_{start}^-)}{\TRx(T_{start}^-)}\right)\TRx(T_{start}^-)<B_0.\label{online_eq_2}
\end{align}
where \eqref{online_eq_3} follows from concavity of $g(p)$, \eqref{online_eq_1} follows form property P4, \eqref{online_eq_2} follows form \eqref{online_T_start}. Since the number of bits that is transmitted by the off-line policy is less than $B_0$, it amounts to a contradiction.
%
%If $T_{start}=r_j$, then then the maximum time for which the receiver can be \textit{on} is $\TRx(T_{start}^-)=\TRx(T_{start})-\TRx_j$, as the off-line policy has to finish at or before $T_{start}$.
%Now, from \eqref{online_eq_4}, the maximum number of bits being transmitted can be bounded by  
%\begin{align}
%&=g\left(\frac{\displaystyle\sum_{i=1}^{i=N}p_i(s_{i+1}-s_{i})}{(s_{N+1}-s_{1})}\right)(s_{N+1}-s_{1}),
%\\
%&=g\left(\frac{\ETx(T_{start}}{\TRx(T_{start}^-)}\right)\TRx(T_{start}^-),
%\\
%&=g\left(\frac{\ETx(T_{start}}{\TRx(T_{start})-\TRx_j}\right)(\TRx(T_{start})-\TRx_j)<B_0
%\label{online_eq_5}
%\end{align}
%where \eqref{online_eq_5} again follows form \eqref{online_T_start}.

Next we estimate the maximum time taken to complete transmission after $T_{start}$ in the on-line algorithm. Let the on-line version transmits at power sequence $\{p_1,p_2,..,p_k\}$ for time $\{l_1,l_2..,l_k\} $. Now, by Lemma \ref{online_power},
\begin{align}
&\sum_{i=1}^{i=k}l_ig(p_i)=B_0\implies\sum_{i=1}^{i=k}l_i\le \frac{B_0}{g(p_1)}.\label{bits}
\end{align}
Now, from the definition of $p_1$, $\frac{\ETx(T_{start})}{p_1}g(p_1)=B_0 \le \TRx(T_{start}) g(\frac{\ETx(T_{start})}{\TRx(T_{start})})$. Hence by property $P4$, $\frac{\ETx(T_{start})}{\TRx(T_{start})}\le p_1$. So, the RHS of (\ref{bits}) can be reduced to, 
\begin{align}
&\frac{B_0}{g(p_1)} = \frac{\ETx(T_{start})}{p_1} \le \TRx(T_{start})\le T_{start}.
\end{align}
where the last inequality followed from the definition of $\TRx(T_{start})$. So we can calculate the competitive ratio for Algorithm \ref{algo_online} as,
\begin{align*}
&r=\displaystyle\max_{\ETx(t),\TRx(t)\hspace{0.5mm} \forall t}\dfrac{T_{online}}{T_{off}} = \dfrac{T_{start}+\displaystyle\sum_{i=1}^{i=k}l_i}{T_{off}} \le \dfrac{2 T_{start}}{T_{off}} < 2
\end{align*}
%where the last inequality followed from \eqref{online_time}.      
\end{proof}
