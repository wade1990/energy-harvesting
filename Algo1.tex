% !TEX root = OptimalOffline.tex
\begin{lemma}
If the reciever has enough energy to stay on for T time, then either the transmitter will transmit for the entire duration T or the transmitter will begin transmission at t=0.
\label{transmission_duration}
\end{lemma}
\begin{proof}
We will prove this by contradiction. Suppose the optimal transmission policy does not begin transmitting at time T and transmits for a duration $T' < T$.\\
Let $p_1$ be the first power of transmission in this policy. If we reduce this slightly to $p_1-\delta p$, we will have transmitted more bits by time $s_{i_{n-1}}$, where $s_{i_{n-1}}$ is the last energy arrival epoch when the transmission power changes. \\
Therefore at the end we can transmit with a power $p'_n > p_n$ (see figure) and complete our transmission at an earlier time.\\
Thus optimally we can keep lowering our first transmission power until we either exhaust our transmission duration T or we hit the origin.
\end{proof}

Suppose we are given a transmission duration T. Our goal is to find a transmission policy so we can minimise the time at which the transmission is completed. To do this, we shall first find a feasible solution and keep improving upon it, until we have a solution that follows all our lemmas. 
\\First, we need an initial feasible solution to start with. For this, we find the minimum energy required by the transmitter so that the transmission can be completed. That is, the first $n$ such that \\\\
$Tg(\frac{\sum_{i=0}^n E_i}{T})\geq B_0$\\\\
Let $\tilde{T}$ be the time duration such that\\\\
$\tilde{T}g(\frac{\sum_{i=0}^n E_i}{\tilde{T}})=B_0$\\\\
Let $\tilde{p}=\frac{\sum_{i=0}^n E_i}{\tilde{T}}$. We try to transmit with this power starting at t=0. If it is feasible, we are done and our transmission is completed in $\tilde{T}$ time.\\
If not, we try to start the transmission as early as possible, such that the transmission is feasible. This transmission curve, will intersect the total energy arrival curve at at least one epoch.\\
Now, we try to improve upon this policy. Let $Q$ be the first point where our transmission curve intersects the energy arrival curve.\\
\begin{lemma}
$Q$ lies in every optimal transmission curve.
\end{lemma}
\begin{proof}
We shall prove this by contradiction. Let the start and end times of the straight line transmission curve described above be $R$ and $S$ .We make the following claims:\\
\textbf{Claim 1:} Every optimal transmission policy begins transmission at or before time $R$\\
Since we are transmitting all the bits at the maximum possible power, no policy that starts after $R$ can finish before $S$. Therefore, any policy that starts after $R$ cannot be optimal.\\
\textbf{Claim 2:} Every optimal transmission policy ends transmission at or before time $S$.\\
This follows immediately from the fact that the policy is optimal. \\
Let $Q$ occur at time $s_k$. Suppose we have an optimal transmission policy that does not pass through point $Q$. Therefore, at $s_k$ the transmission curve lies under the energy arrival curve. The transmission power at time $s_k^+$ has to be more than $tilde{p}$. If it isn't then this policy shall not intersect the energy arrival curve at any epoch till $R$ and because of lemma \ref{lemma_energy_consumed}, it shall not be able to change it's power of transmission till $R$. Therefore, it ends after $R$ and is not optimal.\\
If the policy does have a power higher than $\tilde{p}$ at $s_k^+$, then it must have the same power of transmission right from the beginning of the transmission. This again follows from lemma\ref{lemma_energy_consumed}. Therefore, it shall begin transmission after $R$, which violates claim 1. \\
Therefore every optimal transmission curve passes through $Q$\\
\end{proof}

Now that we have a starting point, we shall proceed to improve upon this policy as follows. Let $s_{lt}$ and $s_{rt}$ be the first and last energy arrival epochs where the power of transmission changes. 
As it is evident, initially both $s_{lt}$ and $s_{rt}$ are set to point $Q$. Now, will iteratively try to omporove on the transmission curve to the left and the right of point $Q$ respectively. 
Keeping in mind Lemma \ref{transmission_duration}, we solve 
\begin{align}
xg(\frac{E^T(s_{lt}}{x}) + (T-x)g(\frac{E^T(n)-E^T(s_{rt})}{T-x}) = B
\end{align}
Notice that $s_{lt} - x$ and $s_{rt} + T-x$ will give us the start and end points of this iteration. Now, we transmit at power $p_{lt} = \frac{E^T(s_{lt})}{x}$ prior to $s_{lt}$ and $p_{rt} = \frac{E^T(n) - E^T(s_{rt})}{T-x}$ after $s_{rt}$. 
If this policy is feasible, then we check for the following. First, we make sure that at the end point, all the available energy is used up, because of it isn't, we can transmit at a higher power and finish earlier. 
If all the energy is not used up, we repeat our iteration, setting $n$ to $n+1$. \\
Also, we make sure that our start point, is not before the origin. If the start point is negative, we set it to origin and continue our iterations accordingly.\\

If the policy is unfeasible on the right, we select the corner point $s_i$ with the minimum slope from $s_{rt}$ and transmit with power $\frac{E^T(s_i) - E^T(s_{rt})}{s_i-s_{rt}}$ between the two points and set $s'_{rt} = s_{rt}$ and $s_{rt} = s_i$ and repeat the process.\\
If the policy is unfeasible on the left, we follow a similar process, be selecting the corner point $s_j$ with the \textit{maximum} slope from point $s_{rt}$.\\
At the end of every iteration we reset our $T$ to $ T - (s_{rt} - s'_{rt}) - (s'_{lt} = s_{lt})$ and we subtract the number of bits transferred between $s_{lt}$ and $s_{rt}$ from $B$



\begin{table}
\begin{minipage}[b]{8cm}
\caption{Offline Algrithm for finding optimal transmission policy, given transmission duration}
\begin{tabular}{p{7cm}}
\hline \textbf{Input}: Bits to transmit $B_0$, transmission duration $T_0$.\\
\hline
\\
\textbf{Initialize:}$B = B_0$, $T = T_0$, n=0
\\
\textbf{While} $Tg(\sum_{j=0}^n E_j) < B_0$
\\
\hspace{4mm} $n = n+1$
\\
Solve for $\tilde{T}: \tilde{T}g(\dfrac{\sum_{j=0}^n E_j}{\tilde{T}})$
\\
$p_0=\dfrac{\sum_{j=0}^n E_j}{\tilde{T}}$
\\
\textbf{for} $i=0,1,2,...n$ \textbf{do}
\\
\hspace{4mm}flag=1
\\
\hspace{4mm}\textbf{for} $j=i,i+1,i+2,...,n$ \textbf{do}
\\
\hspace{7mm}\textbf{if} $p_0s_j + (\sum_{k=0}^i E_k - p_0s_i) > \sum_{k=0}^j E_k$
\\
\hspace{10mm}$t=0$
\\
\hspace{10mm}break
\\
\hspace{7mm}\textbf{end if}
\\
\hspace{4mm}\textbf{end for}
\\
\hspace{4mm}\textbf{if} $flag=1$
\\
\hspace{7mm}$s_{lt} = s_{rt} = s_i$
\\
\hspace{7mm}break
\\
\hspace{4mm}\textbf{end if}
\\
\textbf{end for}
\\
\textbf{while} $B>0$
\\
\hspace{4mm}\textbf{Solve}: $xg(\dfrac{E^T(s_{lt})}{x})+(T-x)g(\dfrac{E^T(n)-E^T(s_{rt})}{T-x}) = B$
\\
\hspace{4mm}$p_{lt} = \dfrac{E^T(s_{lt})}{x}$
\\
\hspace{4mm}$p_{rt} = \dfrac{E^T(n)-E^T(s_{rt})}{T-x}$
\\
\hspace{4mm}$S_{lt} = \{s_0,s_1,s_2,...s_{lt}\}$ \textbf{modify}
\\
\hspace{4mm}$t=0$
\\
\hspace{4mm}\textbf{For} $s_i \in S_{lt}\setminus s_{lt}$
\\
\hspace{7mm}\textbf{If} $p_{lt}s_i + (E^T(s_{lt}) - p_{lt}s_{lt}) > E^T(s_{i-1})$
\\
\hspace{10mm}$s'_{lt} = s_{lt}$
\\
\hspace{10mm}$s_{lt} = \displaystyle \max_{j\in(S_{lt}\setminus {s_{lt}})}(\dfrac{E^T(s_{lt}) - E^T(j)}{s_{lt}-j})$
\\
\hspace{10mm}$t=1$
\\
\hspace{10mm}\textbf{break}
\\
% \hspace{7mm}\textbf{else}
% \\
% \hspace{10mm} $s_{lt} = max(s_{lt} - \dfrac{E^T(s_lt)}{p_{lt}} , 0)$
% \\
\hspace{7mm}\textbf{end if}
\\
\hspace{4mm}\textbf{End For}
\\
\hspace{4mm}\textbf{if} $t=0$
\\
\hspace{7mm}$s_{lt} = max(s_{lt} - \dfrac{E^T(s_lt)}{p_{lt}} , 0)$
\\
\hspace{4mm}\textbf{end if}
\\
\hspace{4mm}$S_{rt} = \{s_{rt},s_{rt}+1,s_{rt}+2,...s_{n-1}\}$ \textbf{modify}
\\
\hspace{4mm}$u=0$
\\
\hspace{4mm}\textbf{For} $s_i \in S_{rt}$
\\
\hspace{7mm}\textbf{If} $p_{rt}s_i + (E^T(s_{rt}) - p_{rt}s_{rt}) > E^T(s_i)$
\\
\hspace{10mm}$s'_{rt} = s_{rt}$
\\
\hspace{10mm}$s_{rt} = \displaystyle \min_{j\in(S_{rt})}(\dfrac{E^T(j)-E^T(s_{lrt})}{j-s_{rt}})$
\\
\hspace{10mm}$u=1$
\\
\hspace{10mm}\textbf{break}
\\
% \hspace{7mm}\textbf{else}
% \\
% \hspace{10mm} $s_{rt} = s_{rt} + \dfrac{E^T(s_n)-E^T(s_rt)}{p_{rt}}$
% \\
% \hspace{10mm}\textbf{If} $s_{rt}>s_{n}$
% \\
% \hspace{13mm}\textbf{While} $s_n < s_{rt}$
% \\
% \hspace{16mm} $n=n+1$
% \\
% \hspace{13mm} \textbf{end while}
% \\
% \hspace{13mm} $s_{rt} = s'_{rt}$
% \\
% \hspace{10mm}\textbf{end for}
% \\
\hspace{7mm}\textbf{end if}
\\
\hspace{4mm}\textbf{End For}
\\
\hspace{4mm}\textbf{if} $u=0$
\\
\hspace{7mm} $s_{rt} = s_{rt} + \dfrac{E^T(s_n)-E^T(s_rt)}{p_{rt}}$
\\
\hspace{7mm}\textbf{If} $s_{rt}>s_{n}$
\\
\hspace{10mm}\textbf{While} $s_n < s_{rt}$
\\
\hspace{13mm} $n=n+1$
\\
\hspace{10mm} \textbf{end while}
\\
\hspace{7mm} $s_{rt} = s'_{rt}$
\\
\hspace{7mm}\textbf{end for}
\\
\hspace{4mm}\textbf{end if}
\\
\hspace{4mm} $T = T - (s_{rt}-s'_{lt}) - (s'_{lt} - s_{lt})$
\\
\hspace{4mm}$B = B -  (s'_{lt}-s_{lt})g(\dfrac{E^T(s'_{lt})-E^T(s_{lt})}{s'_{lt}-s_{lt}}) - (s_{rt}-s'_{rt})g(\dfrac{E^T(s_{rt})-E^T(s'_{rt})}{s_{rt}-s'_{rt}})$
\\
\textbf{end while}
\end{tabular}
\end{minipage}
\end{table}
